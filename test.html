<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strmly Wallet Test Frontend</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .step {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .step h3 {
            color: #666;
            margin-top: 0;
        }
        input, button, textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            margin: 10px 0;
        }
        .output {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Strmly Wallet Test Frontend</h1>
        
        <!-- Step 1: Configuration -->
        <div class="step">
            <h3>Step 1: Configuration</h3>
            <input type="text" id="backendUrl" placeholder="Backend URL" value="http://localhost:3001">
            <input type="text" id="userToken" placeholder="User JWT Token (from login)">
            <input type="text" id="creatorToken" placeholder="Creator JWT Token (from login)">
            <button onclick="testConnection()">Test Backend Connection</button>
            <div id="connectionStatus"></div>
        </div>

        <!-- Step 2: Create Load Order -->
        <div class="step">
            <h3>Step 2: Create Wallet Load Order</h3>
            <input type="number" id="loadAmount" placeholder="Amount to load (e.g., 500)" value="500">
            <button onclick="createLoadOrder()">Create Load Order</button>
            <div id="loadOrderResponse" class="output"></div>
        </div>

        <!-- Step 3: Razorpay Payment -->
        <div class="step">
            <h3>Step 3: Razorpay Payment</h3>
            <p>Click "Pay with Razorpay" to open payment UI and get real payment details</p>
            <button id="payButton" onclick="openRazorpay()" disabled>Pay with Razorpay</button>
            <div id="paymentResponse" class="output"></div>
        </div>

        <!-- Step 4: Verify Payment -->
        <div class="step">
            <h3>Step 4: Verify Payment</h3>
            <button id="verifyButton" onclick="verifyPayment()" disabled>Verify Payment</button>
            <div id="verifyResponse" class="output"></div>
        </div>

        <!-- Step 5: Buy Series -->
        <div class="step">
            <h3>Step 5: Buy Series (70/30 Split)</h3>
            <input type="text" id="seriesId" placeholder="Series ID">
            <input type="number" id="seriesAmount" placeholder="Series Price (e.g., 100)" value="100">
            <button onclick="buySeries()">Buy Series</button>
            <div id="buySeriesResponse" class="output"></div>
        </div>

        <!-- Step 6: Check Wallet -->
        <div class="step">
            <h3>Step 6: Check Wallet Balance</h3>
            <button onclick="checkWallet()">Check User Wallet</button>
            <button onclick="checkCreatorWallet()">Check Creator Wallet</button>
            <div id="walletResponse" class="output"></div>
        </div>

        <!-- Step 7: Gift Comment -->
        <div class="step">
            <h3>Step 7: Gift Comment</h3>
            <input type="text" id="videoIdForGift" placeholder="Video ID">
            <select id="videoTypeForGift">
                <option value="long">Long Video</option>
                <option value="short">Short Video</option>
            </select>
            <input type="text" id="commentIdForGift" placeholder="Comment ID">
            <input type="number" id="giftAmount" placeholder="Gift Amount (e.g., 50)" value="50">
            <input type="text" id="giftNote" placeholder="Gift Note (optional)">
            <button onclick="giftComment()">Send Gift</button>
            <div id="giftResponse" class="output"></div>
        </div>

        <!-- Step 8: Gift History -->
        <div class="step">
            <h3>Step 8: Gift History</h3>
            <select id="giftHistoryType">
                <option value="all">All Gifts</option>
                <option value="sent">Sent Gifts</option>
                <option value="received">Received Gifts</option>
            </select>
            <button onclick="getGiftHistory()">Get Gift History</button>
            <div id="giftHistoryResponse" class="output"></div>
        </div>

        <!-- Step 9: Community Fee -->
        <div class="step">
            <h3>Step 9: Community Fee Payment</h3>
            <input type="text" id="communityId" placeholder="Community ID">
            <input type="number" id="communityFeeAmount" placeholder="Community Fee Amount (e.g., 50)" value="50">
            <input type="text" id="communityFeeNote" placeholder="Fee Note (optional)">
            <button onclick="payCommunityFee()">Pay Community Fee</button>
            <div id="communityFeeResponse" class="output"></div>
        </div>

        <!-- Auto-generated cURL commands -->
        <div class="step">
            <h3>üìã Generated cURL Commands</h3>
            <textarea id="curlCommands" rows="10" placeholder="cURL commands will appear here..."></textarea>
            <button onclick="copyToClipboard()">Copy to Clipboard</button>
        </div>
    </div>

    <script>
        // Global variables
        let backendUrl = 'http://localhost:3001';
        let userToken = '';
        let creatorToken = '';
        let razorpayOrder = null;
        let paymentData = null;

        // Test backend connection
        async function testConnection() {
            backendUrl = document.getElementById('backendUrl').value;
            userToken = document.getElementById('userToken').value;
            creatorToken = document.getElementById('creatorToken').value;
            
            try {
                const response = await fetch(`${backendUrl}/health`);
                const data = await response.text();
                
                document.getElementById('connectionStatus').innerHTML = 
                    `<div class="success">‚úÖ Backend connected: ${data}</div>`;
                
                if (userToken) {
                    document.getElementById('connectionStatus').innerHTML += 
                        `<div class="success">‚úÖ User token configured</div>`;
                }
                
            } catch (error) {
                document.getElementById('connectionStatus').innerHTML = 
                    `<div class="error">‚ùå Connection failed: ${error.message}</div>`;
            }
        }

        // Create wallet load order
        async function createLoadOrder() {
            const amount = document.getElementById('loadAmount').value;
            
            if (!userToken) {
                alert('Please enter user JWT token first');
                return;
            }
            
            try {
                const response = await fetch(`${backendUrl}/api/v1/wallet/load/create-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({ amount: parseInt(amount) })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    razorpayOrder = data;
                    document.getElementById('loadOrderResponse').textContent = 
                        JSON.stringify(data, null, 2);
                    document.getElementById('payButton').disabled = false;
                    
                    // Generate cURL command
                    updateCurlCommands('CREATE_ORDER', `
curl -X POST ${backendUrl}/api/v1/wallet/load/create-order \\
  -H 'Authorization: Bearer ${userToken}' \\
  -H 'Content-Type: application/json' \\
  -d '{
    "amount": ${amount}
  }'`);
                    
                } else {
                    document.getElementById('loadOrderResponse').textContent = 
                        `Error: ${JSON.stringify(data, null, 2)}`;
                }
                
            } catch (error) {
                document.getElementById('loadOrderResponse').textContent = 
                    `Error: ${error.message}`;
            }
        }

        // Open Razorpay payment UI
        function openRazorpay() {
            if (!razorpayOrder) {
                alert('Please create load order first');
                return;
            }
            
            const options = {
                key: razorpayOrder.razorpayConfig.key,
                amount: razorpayOrder.razorpayConfig.amount,
                currency: razorpayOrder.razorpayConfig.currency,
                name: razorpayOrder.razorpayConfig.name,
                description: razorpayOrder.razorpayConfig.description,
                order_id: razorpayOrder.razorpayConfig.order_id,
                prefill: razorpayOrder.razorpayConfig.prefill,
                theme: {
                    color: '#007bff'
                },
                handler: function (response) {
                    // Success - got payment details
                    paymentData = {
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_signature: response.razorpay_signature
                    };
                    
                    document.getElementById('paymentResponse').textContent = 
                        `‚úÖ Payment Successful!\n\n${JSON.stringify(paymentData, null, 2)}`;
                    
                    document.getElementById('verifyButton').disabled = false;
                    
                    // Generate cURL command for verification
                    updateCurlCommands('VERIFY_PAYMENT', `
curl -X POST ${backendUrl}/api/v1/wallet/load/verify \\
  -H 'Authorization: Bearer ${userToken}' \\
  -H 'Content-Type: application/json' \\
  -d '{
    "razorpay_order_id": "${paymentData.razorpay_order_id}",
    "razorpay_payment_id": "${paymentData.razorpay_payment_id}",
    "razorpay_signature": "${paymentData.razorpay_signature}"
  }'`);
                },
                modal: {
                    ondismiss: function() {
                        document.getElementById('paymentResponse').textContent = 
                            '‚ùå Payment cancelled by user';
                    }
                }
            };
            
            const rzp = new Razorpay(options);
            rzp.open();
        }

        // Verify payment
        async function verifyPayment() {
            if (!paymentData) {
                alert('Please complete payment first');
                return;
            }
            
            try {
                const response = await fetch(`${backendUrl}/api/v1/wallet/load/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(paymentData)
                });
                
                const data = await response.json();
                
                document.getElementById('verifyResponse').textContent = 
                    JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    document.getElementById('verifyResponse').innerHTML = 
                        `<div class="success">‚úÖ Payment verified successfully!</div>
                        <div class="output">${JSON.stringify(data, null, 2)}</div>`;
                }
                
            } catch (error) {
                document.getElementById('verifyResponse').textContent = 
                    `Error: ${error.message}`;
            }
        }

        // Buy series with 70/30 split
        async function buySeries() {
            const seriesId = document.getElementById('seriesId').value;
            const amount = document.getElementById('seriesAmount').value;
            
            if (!seriesId || !amount) {
                alert('Please enter series ID and amount');
                return;
            }
            
            try {
                const response = await fetch(`${backendUrl}/api/v1/wallet/transfer/series`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        seriesId: seriesId,
                        amount: parseInt(amount),
                        transferNote: 'Test purchase from frontend'
                    })
                });
                
                const data = await response.json();
                
                document.getElementById('buySeriesResponse').textContent = 
                    JSON.stringify(data, null, 2);
                
                // Generate cURL command
                updateCurlCommands('BUY_SERIES', `
curl -X POST ${backendUrl}/api/v1/wallet/transfer/series \\
  -H 'Authorization: Bearer ${userToken}' \\
  -H 'Content-Type: application/json' \\
  -d '{
    "seriesId": "${seriesId}",
    "amount": ${amount},
    "transferNote": "Test purchase from frontend"
  }'`);
                
            } catch (error) {
                document.getElementById('buySeriesResponse').textContent = 
                    `Error: ${error.message}`;
            }
        }

        // Check wallet balance
        async function checkWallet() {
            try {
                const response = await fetch(`${backendUrl}/api/v1/wallet`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                const data = await response.json();
                
                document.getElementById('walletResponse').textContent = 
                    `User Wallet:\n${JSON.stringify(data, null, 2)}`;
                
            } catch (error) {
                document.getElementById('walletResponse').textContent = 
                    `Error: ${error.message}`;
            }
        }

        // Check creator wallet balance
        async function checkCreatorWallet() {
            try {
                const response = await fetch(`${backendUrl}/api/v1/wallet`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${creatorToken}`
                    }
                });
                
                const data = await response.json();
                
                document.getElementById('walletResponse').textContent = 
                    `Creator Wallet:\n${JSON.stringify(data, null, 2)}`;
                
            } catch (error) {
                document.getElementById('walletResponse').textContent = 
                    `Error: ${error.message}`;
            }
        }

        // Gift comment
        async function giftComment() {
            const videoId = document.getElementById('videoIdForGift').value;
            const videoType = document.getElementById('videoTypeForGift').value;
            const commentId = document.getElementById('commentIdForGift').value;
            const amount = document.getElementById('giftAmount').value;
            const giftNote = document.getElementById('giftNote').value;
            
            if (!videoId || !commentId || !amount) {
                alert('Please enter video ID, comment ID, and gift amount');
                return;
            }
            
            try {
                const response = await fetch(`${backendUrl}/api/v1/interaction/gift-comment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        videoId: videoId,
                        videoType: videoType,
                        commentId: commentId,
                        amount: parseInt(amount),
                        giftNote: giftNote
                    })
                });
                
                const data = await response.json();
                
                document.getElementById('giftResponse').textContent = 
                    JSON.stringify(data, null, 2);
                
                // Generate cURL command
                updateCurlCommands('GIFT_COMMENT', `
curl -X POST ${backendUrl}/api/v1/interaction/gift-comment \\
  -H 'Authorization: Bearer ${userToken}' \\
  -H 'Content-Type: application/json' \\
  -d '{
    "videoId": "${videoId}",
    "videoType": "${videoType}",
    "commentId": "${commentId}",
    "amount": ${amount},
    "giftNote": "${giftNote}"
  }'`);
                
            } catch (error) {
                document.getElementById('giftResponse').textContent = 
                    `Error: ${error.message}`;
            }
        }

        // Get gift history
        async function getGiftHistory() {
            const type = document.getElementById('giftHistoryType').value;
            
            try {
                const response = await fetch(`${backendUrl}/api/v1/wallet/gifts?type=${type}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                const data = await response.json();
                
                document.getElementById('giftHistoryResponse').textContent = 
                    JSON.stringify(data, null, 2);
                
                // Generate cURL command
                updateCurlCommands('GIFT_HISTORY', `
curl -X GET ${backendUrl}/api/v1/wallet/gifts?type=${type} \\
  -H 'Authorization: Bearer ${userToken}'`);
                
            } catch (error) {
                document.getElementById('giftHistoryResponse').textContent = 
                    `Error: ${error.message}`;
            }
        }

        // Pay community fee
        async function payCommunityFee() {
            const communityId = document.getElementById('communityId').value;
            const amount = document.getElementById('communityFeeAmount').value;
            const feeNote = document.getElementById('communityFeeNote').value;
            
            if (!communityId || !amount) {
                alert('Please enter community ID and fee amount');
                return;
            }
            
            try {
                const response = await fetch(`${backendUrl}/api/v1/wallet/transfer/community-fee`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        communityId: communityId,
                        amount: parseInt(amount),
                        feeNote: feeNote
                    })
                });
                
                const data = await response.json();
                
                document.getElementById('communityFeeResponse').textContent = 
                    JSON.stringify(data, null, 2);
                
                // Generate cURL command
                updateCurlCommands('PAY_COMMUNITY_FEE', `
curl -X POST ${backendUrl}/api/v1/wallet/transfer/community-fee \\
  -H 'Authorization: Bearer ${userToken}' \\
  -H 'Content-Type: application/json' \\
  -d '{
    "communityId": "${communityId}",
    "amount": ${amount},
    "feeNote": "${feeNote}"
  }'`);
                
            } catch (error) {
                document.getElementById('communityFeeResponse').textContent = 
                    `Error: ${error.message}`;
            }
        }
        

        // Update cURL commands
        function updateCurlCommands(step, command) {
            const textarea = document.getElementById('curlCommands');
            const current = textarea.value;
            textarea.value = current + `\n\n# ${step}\n${command}`;
        }

        // Copy to clipboard
        function copyToClipboard() {
            const textarea = document.getElementById('curlCommands');
            textarea.select();
            document.execCommand('copy');
            alert('cURL commands copied to clipboard!');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('backendUrl').value = backendUrl;
        });
    </script>
</body>
</html>